import Head from "next/head";
import React, { useEffect, useState } from "react";
import Link from "next/link";
import PokemonListContainer from "../container/PokemonListContainer";
import styled from "@emotion/styled";
import Layout from "../container/Layout";
import Header from "../components/Header";
import MainContainer from "../container/MainContainer";
import FixedMainContainer from "../container/FixedMainContainer";
import { useQuery } from "@apollo/client";
import { GET_POKEMONS } from "../graphql/apis";
import { useAppContext } from "../context/state";
import { initializeApollo } from "../lib/apolloClient";
import { extractNumber } from "../lib/helpers/stringHelper";
import LoadMore from "../components/LoadMore";
import Button from "../components/Button";

const restructuredData = (data) => {
    let results = [];
    const keys = Object.keys(data);

    keys.map((k) => {
        results = [...results, data[k]];
    });
    console.log(results);
    // const test = props.data.map((d) => d);
    // props.data &&
    //     props.data.map((d) => {
    //         results = [...results, d];
    //     });
    results.pop();
    const hasil = {
        pokemons: {
            results: results,
        },
    };

    return hasil;
};

export default function Home(props) {
    // saving state immediately because props.data already exist (caused by SSR)
    const state = useAppContext();
    state.setPokemons(props.data.pokemons.results);
    const [data, setData] = useState(props.data);

    // const { loading, error, data } = useQuery(GET_POKEMONS, {
    //     variables: {
    //         limit: 10,
    //         offset: 0,
    //     },
    // });

    useEffect(() => {
        state.saveState();
    }, [state]);

    console.log("data, state", data, state);
    useEffect(() => {
        state.setPokemons(props.data.pokemons.results);
        setData(props.data);
    });
    // console.log(props.data, data);

    // useEffect(() => {
    //     if (data) state.setPokemons(data.pokemons.results);
    // }, [data]);
    const onClickLoadMore = () => {
        console.log("run");
    };
    return (
        <Layout>
            <Head>
                <title>Pokedex</title>
                <meta name="description" content="Generated by create next app" />
            </Head>
            <Header />
            <MainContainer>
                <FixedMainContainer>
                    <PokemonListContainer data={data} />
                    <div style={{ display: "flex", justifyContent: "center", margin: "10px 0" }}>
                        <Button onClick={onClickLoadMore}>Load more</Button>
                    </div>
                </FixedMainContainer>
            </MainContainer>
        </Layout>
    );
}

export async function getServerSideProps() {
    const apolloClient = initializeApollo();

    const res = await apolloClient.query({
        query: GET_POKEMONS,
        variables: {
            limit: 10,
            offset: 0,
        },
    });

    console.log("res", res);

    return {
        props: {
            // data: apolloClient.cache.extract(),
            data: res.data,
        },
    };
}
